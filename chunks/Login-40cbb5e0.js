import{d as e,r as a,w as l,Y as s,f as t,a3 as o,aa as u,U as i,o as r,c as d,a as n,R as c,L as v,Q as p,X as h,M as m,u as g,a4 as f,al as b}from"./@vue-3d1b68dd.js";import{d as w}from"./vue-router-82f82b94.js";import{g as x,p as y,t as z,l as k,a as _,s as L}from"../index-498d2843.js";import{a as j}from"./axios-ff411c8f.js";import{a as X,c as Y,d as S,f as U,g as $,h as V}from"./element-plus-68af0c8f.js";import{_ as C}from"./plugin-vue_export-helper-3b0dab4c.js";import"./mitt-106818fe.js";import"./lodash-es-7a4ab7c3.js";import"./@popperjs-66964824.js";import"./@vueuse-63a82237.js";import"./@element-plus-0d456ff2.js";import"./async-validator-b6f94fc9.js";import"./@ctrl-d2fe7c9e.js";import"./normalize-wheel-es-233dc293.js";const R={class:"slider-container"},E={class:"slider-square"},T={class:"box"},D=e({__name:"SlipCaptcha",props:{loading:{type:Boolean,default:!1}},emits:["validPass"],setup(e,{expose:h,emit:m}){const g=a(!1),f=e;l((()=>f.loading),(e=>{g.value=e}));const b=m;h({updateSlideCaptcha:D});const w=a(null),k=a(null),_=a({hash:"",puzzleUrl:"",width:300,height:225,sliderUrl:"",sliderSize:0,sliderY:0,sliderLeft:0,blockX:0,blockY:0,scaleRatio:1,sliderText:""}),L=s({originX:0}),Y=s({class:"",height:0});t((()=>{q(),D()}));const S=a(!1),U=a([]),$=e=>{S.value=!0,_.value.sliderText="";const a="touches"in e?e.touches[0].pageX:e.pageX;L.originX=a,k.value&&(k.value.style.willChange="transform"),U.value=[];const l="touches"in e?e.touches[0].pageY:e.pageY;U.value.push({pointerX:a,pointerY:l,t:Date.now()}),e.preventDefault()},V=e=>{if(!S.value)return;const a="touches"in e?e.touches[0].pageX:e.pageX,l="touches"in e?e.touches[0].pageY:e.pageY,s=a-L.originX,t=_.value.width-_.value.sliderSize,o=Math.max(0,Math.min(s,t));k.value&&(k.value.style.transform=`translate3d(${o}px,0,0)`),_.value.sliderLeft=o,U.value.push({pointerX:a,pointerY:l,t:Date.now()}),e.preventDefault()},C=()=>{if(!S.value)return;S.value=!1,k.value&&(k.value.style.willChange="auto");const e=_.value.sliderLeft/_.value.scaleRatio;var a,l,s;(a=e,l=_.value.hash,s=U.value,j.post(`/v1${x}auth/${y}/captcha/slide/validate`,{sliderX:a,hash:l,track:s})).then((e=>{e.data.result?(b("validPass",{hash:_.value.hash,code:e.data.code}),D()):(X.error(z("captcha.validate.fail")),D())}))};function D(){g.value=!0,k.value&&(k.value.style.transform="translate3d(0,0,0)"),_.value.sliderLeft=0,j.get(`/v1${x}auth/${y}/captcha/slide?`+(new Date).getTime()).then((e=>{_.value.hash=e.data.hash,_.value.puzzleUrl=e.data.puzzleUrl,_.value.width=e.data.width,_.value.height=e.data.height,_.value.sliderUrl=e.data.sliderUrl,_.value.sliderSize=e.data.sliderSize,_.value.blockY=e.data.sliderY})).then((()=>{_.value.sliderText="拖动滑块完成验证",Y.height=0,Y.class="",_.value.sliderLeft=0,k.value&&(k.value.style.left="0"),w.value&&(_.value.scaleRatio=300/_.value.width,_.value.width*=_.value.scaleRatio,_.value.height*=_.value.scaleRatio,_.value.blockY*=_.value.scaleRatio,_.value.sliderSize*=_.value.scaleRatio)})).finally((()=>{g.value=!1}))}const q=()=>{document.addEventListener("mousemove",V),document.addEventListener("mouseup",C),document.addEventListener("touchmove",V,{passive:!1}),document.addEventListener("touchend",C)};return o((()=>{document.removeEventListener("mousemove",V),document.removeEventListener("mouseup",C),document.removeEventListener("touchmove",V),document.removeEventListener("touchend",C)})),(e,a)=>{const l=u("loading");return i((r(),d("div",R,[n("div",{class:"slider-canvas",style:c({width:`${_.value.width}px`,height:`${_.value.height}px`}),onClick:D},[n("div",{ref_key:"puzzle",ref:w,class:"puzzle-image",style:c({backgroundImage:`url(${_.value.puzzleUrl})`,width:"100%",height:"100%",position:"absolute",top:0,left:0,backgroundSize:"cover"})},null,4),n("div",{ref_key:"block",ref:k,class:"slider-block",style:c({backgroundImage:`url(${_.value.sliderUrl})`,width:_.value.sliderSize+"px",height:_.value.sliderSize+"px",top:_.value.blockY+"px",left:"0px",position:"absolute",backgroundSize:"cover"})},null,4),n("div",{class:v(`result-mask ${Y.class}`),style:c({height:`${Y.height}px`})},null,6)],4),n("div",E,[n("div",T,[n("div",{class:"slider-square-icon",style:c({transform:`translateX(${_.value.sliderLeft}px)`}),onMousedown:$,onTouchstart:$},null,36),n("span",null,p(_.value.sliderText),1)])])])),[[l,g.value]])}}});const q={class:"login-container"},M={class:"logo-container"},I={class:"logo-text"};var P=C(e({__name:"Login",setup(e){const l=w(),t=a(),o=a(!1),u=a(!1),i=s({username:"",password:""}),c={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]},v=()=>{u.value=!0,t.value.updateSlideCaptcha()},x=e=>{o.value=!0,k(i.username,i.password,e.code,e.hash).then((async()=>{try{const e=await _();L(e.data),e.data.role>1?l.push("/chat/assistant"):l.push("/")}catch(e){L(null),l.push("/")}})).catch((e=>{401===e.status&&(u.value=!1,X.error(z("login.fail")))}))};return(e,a)=>(r(),d("div",q,[h(g($),{ref:"loginForm",model:i,rules:c,"label-position":"left","label-width":"0px",class:"login-form",onKeyup:b(v,["enter"])},{default:m((()=>[n("div",M,[n("h2",I,p(g(z)("ai.center.title")),1)]),h(g(Y),{prop:"username"},{default:m((()=>[h(g(S),{modelValue:i.username,"onUpdate:modelValue":a[0]||(a[0]=e=>i.username=e),placeholder:"用户名"},null,8,["modelValue"])])),_:1}),h(g(Y),{prop:"password"},{default:m((()=>[h(g(S),{modelValue:i.password,"onUpdate:modelValue":a[1]||(a[1]=e=>i.password=e),type:"password",placeholder:"密码"},null,8,["modelValue"])])),_:1}),h(g(Y),null,{default:m((()=>[h(g(U),{type:"primary",onClick:v,class:"submit-btn"},{default:m((()=>[...a[4]||(a[4]=[f(" 登录 ",-1)])])),_:1})])),_:1})])),_:1},8,["model"]),h(g(V),{modelValue:u.value,"onUpdate:modelValue":a[2]||(a[2]=e=>u.value=e),class:"captcha-dialog","align-center":"",loading:o.value,"show-close":"",onClose:a[3]||(a[3]=e=>o.value=!1),draggable:""},{default:m((()=>[h(D,{ref_key:"slideCaptchaRef",ref:t,loading:o.value,onValidPass:x},null,8,["loading"])])),_:1},8,["modelValue","loading"])]))}}),[["__scopeId","data-v-330f95b9"]]);export{P as default};
