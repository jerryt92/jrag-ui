var t=function(e,s){if(!(this instanceof t))return new t(e,s);this.url=e,s=s||{},this.headers=s.headers||{},this.payload=void 0!==s.payload?s.payload:"",this.method=s.method||this.payload&&"POST"||"GET",this.withCredentials=!!s.withCredentials,this.debug=!!s.debug,this.autoReconnect=void 0!==s.autoReconnect&&s.autoReconnect,this.reconnectDelay=void 0!==s.reconnectDelay?s.reconnectDelay:3e3,this.maxRetries=void 0!==s.maxRetries?s.maxRetries:null,this.retryCount=0,this.reconnectTimer=null,this.useLastEventId=void 0===s.useLastEventId||s.useLastEventId,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=t.INITIALIZING,this.progress=0,this.chunk="",this.lastEventId="",this.addEventListener=function(t,e){void 0===this.listeners[t]&&(this.listeners[t]=[]),-1===this.listeners[t].indexOf(e)&&this.listeners[t].push(e)},this.removeEventListener=function(t,e){if(void 0===this.listeners[t])return;const s=[];this.listeners[t].forEach((function(t){t!==e&&s.push(t)})),0===s.length?delete this.listeners[t]:this.listeners[t]=s},this.dispatchEvent=function(t){if(!t)return!0;this.debug,t.source=this;const e="on"+t.type;return(!this.hasOwnProperty(e)||(this[e].call(this,t),!t.defaultPrevented))&&(!this.listeners[t.type]||this.listeners[t.type].every((function(e){return e(t),!t.defaultPrevented})))},this._markClosed=function(){if(this.xhr=null,this.progress=0,this.chunk="",this._setReadyState(t.CLOSED),this.autoReconnect){if(null!==this.maxRetries&&this.retryCount>=this.maxRetries)return this.debug,this.autoReconnect=!1,void this.close();this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.debug,this.reconnectTimer=setTimeout((()=>{this.reconnectTimer=null,this.retryCount++,this.stream()}),this.reconnectDelay)}},this._setReadyState=function(t){const e=new CustomEvent("readystatechange");e.readyState=t,this.readyState=t,this.dispatchEvent(e)},this._onStreamFailure=function(t){const e=new CustomEvent("error");e.responseCode=t.currentTarget.status,e.data=t.currentTarget.response,this.dispatchEvent(e),this._markClosed()},this._onStreamAbort=function(){this.dispatchEvent(new CustomEvent("abort")),this._markClosed()},this._onStreamProgress=function(t){if(!this.xhr)return;if(this.xhr.status<200||this.xhr.status>=300)return void this._onStreamFailure(t);this.retryCount=0;const e=this.xhr.responseText.substring(this.progress);this.progress+=e.length;const s=(this.chunk+e).split(/(\r\n\r\n|\r\r|\n\n)/g),i=s.pop();s.forEach(function(t){t.trim().length>0&&this.dispatchEvent(this._parseEventChunk(t))}.bind(this)),this.chunk=i},this._onStreamLoaded=function(t){this._onStreamProgress(t),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk="",this._markClosed()},this._parseEventChunk=function(t){if(!t||0===t.length)return null;this.debug;const e={id:null,retry:null,data:null,event:null};if(t.split(/\n|\r\n|\r/).forEach(function(t){const s=t.indexOf(this.FIELD_SEPARATOR);let i,n;if(s>0){const e=" "===t[s+1]?2:1;i=t.substring(0,s),n=t.substring(s+e)}else{if(!(s<0))return;i=t,n=""}i in e&&("data"===i&&null!==e[i]?e.data+="\n"+n:e[i]=n)}.bind(this)),null===e.data)return null;null!==e.id&&(this.lastEventId=e.id);const s=new CustomEvent(e.event||"message");return s.id=e.id,s.data=e.data||"",s.lastEventId=this.lastEventId,s},this._onReadyStateChange=function(){if(this.xhr&&this.xhr.readyState===XMLHttpRequest.HEADERS_RECEIVED){const e={},s=this.xhr.getAllResponseHeaders().trim().split("\r\n");for(const t of s){const[s,...i]=t.split(":"),n=i.join(":").trim();e[s.trim().toLowerCase()]=e[s.trim().toLowerCase()]||[],e[s.trim().toLowerCase()].push(n)}const i=new CustomEvent("open");i.responseCode=this.xhr.status,i.headers=e,this.dispatchEvent(i),this._setReadyState(t.OPEN)}},this.stream=function(){if(!this.xhr){this._setReadyState(t.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._onReadyStateChange.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(let t in this.headers)this.xhr.setRequestHeader(t,this.headers[t]);this.useLastEventId&&this.lastEventId.length>0&&this.xhr.setRequestHeader("Last-Event-ID",this.lastEventId),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==t.CLOSED&&(this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.autoReconnect=!1,this.xhr.abort())},(void 0===s.start||s.start)&&this.stream()};t.INITIALIZING=-1,t.CONNECTING=0,t.OPEN=1,t.CLOSED=2,"undefined"!=typeof exports&&(exports.SSE=t);export{t as S};
