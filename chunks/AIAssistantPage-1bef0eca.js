import{d as e,r as a,w as t,o as s,c as l,a as n,A as o,u as i,K as r,X as c,M as u,a4 as d,Q as v,U as h,V as f,ab as m,n as p,L as g,P as y,f as w,G as b,J as x,aa as A}from"./@vue-bb747027.js";import{x as k,y as C,A as T,e as P,B as E}from"./@element-plus-ccefd8d4.js";import{M as j}from"./markdown-it-cd7d6dfa.js";import{a as H,d as q,g as L,c as I,b as M,e as S,f as F}from"./ai.api-e87da04c.js";import{t as N}from"../index-b5aeebb0.js";import{_ as U}from"./plugin-vue_export-helper-3b0dab4c.js";import{d as B,f as _,a as z,i as O,j as Q,k as R,l as G,m as J,n as V,o as W}from"./element-plus-310660e5.js";import{u as X}from"./vue-router-6370cc0f.js";import{T as Z}from"./topoBar-d9c8440e.js";import{k as Y}from"./lodash-es-7a4ab7c3.js";import"./mdurl-265342ab.js";import"./uc.micro-caa990fc.js";import"./linkify-it-fb3f2949.js";import"./punycode.js-94cdf097.js";import"./axios-ff411c8f.js";import"./mitt-106818fe.js";import"./@popperjs-66964824.js";import"./@vueuse-09ca9f25.js";import"./async-validator-b6f94fc9.js";import"./@ctrl-d2fe7c9e.js";import"./normalize-wheel-es-233dc293.js";const K={class:"chat-manage-container"},D={class:"chat-manage-card"},$={class:"chat-manage-header"},ee={class:"chat-list"},ae={class:"list-title fx"},te={class:"text"},se={class:"list-content"},le=["onClick"];var ne=U(e({__name:"chatManage",props:{newChat:{type:Function,required:!0,default:()=>{}},historyChat:{type:Function,required:!0,default:()=>{}},currContextId:{type:String,default:""},messageContext:{type:Array,default:()=>[]}},emits:["showChatManage"],setup(e,{expose:w,emit:b}){const x=e,A=a(),C=a(!1),T=a(""),P=a([]),E=a([]),j=a(x.currContextId),L=b;t((()=>x.currContextId),(e=>{j.value=e}));const I=()=>{L("showChatManage",!1),x.messageContext?.length?(j.value="",x.newChat(),M()):z({message:N("ai.already.latest.chat"),type:"success"})},M=()=>{H().then((e=>{P.value=e.data.data,F(T.value,e.data.data)}))},S=e=>{const a=[];e?a.push(e):P.value.forEach((e=>{a.push(e.contextId)})),O.confirm(N("ai.delete.warning"),N(e?"ai.delete.chat.confirm":"ai.delete.all.chat.confirm"),{confirmButtonText:N("common.ok"),cancelButtonText:N("common.cancel"),type:"warning"}).then((()=>{q(a).then((a=>{M(),e===j.value&&I()}))}))};t((()=>T.value),(e=>{F(e)}));const F=(e,a)=>{const t=new RegExp(e,"i"),s=a||P.value;E.value=s.filter((e=>t.test(e.title)))};return w({getHistoryListData:M}),(e,a)=>(s(),l("div",K,[n("div",D,[n("div",$,[C.value?(s(),o(i(B),{key:0,ref_key:"searchInputRef",ref:A,modelValue:T.value,"onUpdate:modelValue":a[0]||(a[0]=e=>T.value=e),class:"search-input",placeholder:e.$t("ai.search.history.context"),"suffix-icon":i(k),autofocus:"",onBlur:a[1]||(a[1]=e=>C.value=!1)},null,8,["modelValue","placeholder","suffix-icon"])):(s(),l(r,{key:1},[c(i(_),{type:"primary",class:"add",round:"",onClick:I},{default:u((()=>[a[4]||(a[4]=n("i",{class:"iconfont icon-chat-new"},null,-1)),d(v(e.$t("ai.add.new.chat")),1)])),_:1}),c(i(_),{class:"search-button",icon:i(k),circle:"",onClick:a[2]||(a[2]=e=>(C.value=!0,void p((()=>{T.value="",A.value.focus()}))))},null,8,["icon"])],64))]),h(n("div",ee,[n("div",ae,[n("div",te,v(e.$t("ai.history.chat")),1),n("div",{class:"delete",onClick:a[3]||(a[3]=e=>S())},[a[5]||(a[5]=n("i",{class:"iconfont icon-trash-alt"},null,-1)),d(v(e.$t("ai.delete.all.chat")),1)])]),n("div",se,[(s(!0),l(r,null,m(E.value,((e,t)=>(s(),l("div",{key:t,class:g(["list-item fx",{active:j.value===e.contextId}])},[n("div",{class:"cont fx",style:{height:"100%"},onClick:a=>{return t=e.contextId,L("showChatManage",!1),j.value=t,x.historyChat(t),void(T.value="");var t}},[a[6]||(a[6]=n("i",{class:"iconfont icon-lishiduihua"},null,-1)),n("p",null,v(e.title),1)],8,le),c(i(G),{trigger:"hover",teleported:!1},{dropdown:u((()=>[c(i(Q),null,{default:u((()=>[c(i(R),{onClick:y((a=>S(e.contextId)),["stop"])},{default:u((()=>[a[7]||(a[7]=n("i",{class:"iconfont icon-trash-alt"},null,-1)),d(" "+v(i(N)("common.delete")),1)])),_:1},8,["onClick"])])),_:2},1024)])),default:u((()=>[a[8]||(a[8]=n("span",{class:"el-dropdown-link"},[n("span",{class:"iconfont icon-vgengduo"},"...")],-1))])),_:2},1024)],2)))),128))])],512),[[f,E.value?.length]])])]))}}),[["__scopeId","data-v-ab3d4718"]]);const oe=e=>e&&0!==e.length?e.map((e=>`- [${e.fullFileName}](${e.url})`)).join("\n"):"";const ie={key:0,class:"chat-view"},re={class:"message-init"},ce={class:"title"},ue={class:"hot-questions"},de={class:"fx hot-questions-title"},ve={class:"fx"},he={class:"question-list"},fe=["onClick"],me={key:0,class:"message-list"},pe={class:"message-content"},ge=["innerHTML"],ye={class:"src-file"},we=["innerHTML"],be={class:"support"},xe=["onClick"],Ae=["onClick"],ke=["innerHTML"],Ce={class:"avatar-wrap"},Te={class:"input-area"};var Pe=U(e({__name:"ChatView",props:{isFullscreen:{type:Boolean,default:!1},isMobile:{type:Boolean,default:!1}},setup(e,{expose:t}){const o=new j({html:!0,linkify:!0,typographer:!0});o.renderer.rules.paragraph_open=function(e,a){return'<p style="line-height: var(--n-font-line-height-4);">'},o.renderer.rules.link_open=function(e,a,t,s,l){return e[a].attrPush(["target","_blank"]),l.renderToken(e,a,t)},o.renderer.rules.table_open=function(){return'<table class="md-table">'},o.renderer.rules.thead_open=function(){return'<thead class="md-thead">'},o.renderer.rules.tbody_open=function(){return'<tbody class="md-tbody">'},o.renderer.rules.tr_open=function(){return'<tr class="md-tr">'},o.renderer.rules.th_open=function(){return'<th class="md-th">'},o.renderer.rules.td_open=function(){return'<td class="md-td">'};const y=a(!1),A=a(null),k=a(),H=a(),q=a(!0),U=a([]),O=a(""),Q=a(!1),R=a(!0);let G;const X=e=>{Q.value?z.info(N("ai.assistant.waiting")):L().then((()=>{if(e&&(O.value=e),O.value.trim()){Q.value=!0,Y();const e={index:U.value.length,content:O.value,role:"user"};U.value.push(e),O.value="";const a={contextId:k.value,messages:U.value,retrievalKb:!0,systemPrompt:"GENERAL_ASSISTANT"};G=I(k.value),G.onopen=()=>{G.send(JSON.stringify(a)),R.value&&(U.value.push({index:U.value.length,role:"assistant",content:""}),R.value=!1),Y()},G.onmessage=e=>{try{const a=JSON.parse(e.data);Z(a)}catch(a){}},G.onerror=e=>{401===e.responseCode?window.location.assign("/#/login"):0!==e.responseCode&&(z.error(N("ai.assistant.service.unavailable")),Q.value=!1,R.value=!0)}}}))},Z=e=>{K(),q.value&&Y(),e.message&&("system"===e.message?.role?(U.value[U.value.length-1]=e.message,U.value.push({index:U.value.length,role:"assistant",content:""})):"assistant"===e.message?.role&&(U.value[U.value.length-1].index,e.message.index,!0===e.done?(U.value[U.value.length-1].content+=e.message.content,Q.value=!1,R.value=!0,p((()=>{G.close()}))):(e.message.srcFile&&e.message.srcFile.length>0&&(U.value[U.value.length-1].srcFile=e.message.srcFile),e.message.content&&(U.value[U.value.length-1].content+=e.message.content))))},Y=()=>{p((()=>{H.value&&H.value.wrapRef.scrollTo({top:H.value.wrapRef.scrollHeight,behavior:"smooth"})}))},K=()=>{if(H.value){const{scrollTop:e,scrollHeight:a,clientHeight:t}=H.value.wrapRef;q.value=e+100>a-t}};let D=!0;const $=e=>{"Enter"!==e.key||e.shiftKey||(D=!0,e.preventDefault())},ee=()=>{D=!1},ae=()=>{D&&(D=!1,X())},te=a([]),se=()=>{M().then((e=>{te.value=e.data.data}))},le=(e,a)=>{a.feedback=e,F({contextId:k.value,index:a.index,feedback:e}).then((a=>{1===e&&z({message:"üòä",type:"info"}),2===e&&z({message:"üò≠",type:"info"})}))},Pe=()=>{je(),O.value="",U.value=[],q.value=!0,L().then((e=>{k.value=e.data.contextId})),se(),Y()},Ee=e=>{je(),O.value="",e!==k.value&&A.value.getHistoryListData(),k.value=e,S(e).then((e=>{U.value=e.data.messages,Y()}))},je=()=>{Q.value=!1,R.value=!0,G&&G.close()};return w((()=>{Pe()})),b((()=>{je()})),t({showChatManage:y,chatManageRef:A,getHistoryListData:()=>A.value.getHistoryListData(),newChat:Pe}),(a,t)=>(s(),l("div",{class:g(["chat-container",{fullscreen:e.isFullscreen,"is-mobile":e.isMobile}])},[h(c(ne,{class:"chat-manage",ref_key:"chatManageRef",ref:A,"new-chat":Pe,"history-chat":Ee,"curr-context-id":k.value,"message-context":U.value,onShowChatManage:t[0]||(t[0]=e=>y.value=e)},null,8,["curr-context-id","message-context"]),[[f,y.value||e.isFullscreen]]),!y.value||e.isFullscreen||e.isMobile&&!y.value?(s(),l("div",ie,[c(i(V),{ref_key:"scrollbarRef",ref:H,class:"scroll",onScroll:K},{default:u((()=>[n("div",re,[t[4]||(t[4]=n("div",{class:"ai-logo"},[n("span",{style:{"font-size":"100px"}},"ü§ñ")],-1)),n("h2",ce,v(a.$t("ai.hi.assistant")),1),n("div",ue,[n("div",de,[n("strong",ve,[c(i(J),null,{default:u((()=>[c(i(C))])),_:1}),d(" "+v(a.$t("ai.hot.question")),1)]),n("span",{class:"change fx",onClick:se},[d(v(a.$t("ai.refresh.hot.question")),1),c(i(J),null,{default:u((()=>[c(i(T))])),_:1})])]),n("div",he,[(s(!0),l(r,null,m(te.value,((e,a)=>(s(),l("div",{key:a,class:"question",onClick:a=>{return t=e.question,void X(t);var t}},[t[3]||(t[3]=n("strong",{class:"qa"},"HOT",-1)),d(v(e.question),1)],8,fe)))),128))])])]),U.value?.length?(s(),l("div",me,[(s(!0),l(r,null,m(U.value,((e,m)=>(s(),l("div",{key:m,class:g(["message-row",[e.role]])},["assistant"===e.role?(s(),l(r,{key:0},[n("div",{class:g(["avatar-wrap",[Q.value&&m===U.value.length-1?"thinking-avatar":""]])},[c(i(W),{size:50,class:"ai-chat-logo"},{default:u((()=>[...t[5]||(t[5]=[n("span",{style:{"font-size":"30px",margin:"auto"}},"ü§ñ",-1)])])),_:1})],2),n("div",pe,[n("div",{innerHTML:i(o).render(e.content+(Q.value&&m===U.value.length-1?"...":""))},null,8,ge),h(n("div",ye,[t[6]||(t[6]=n("br",null,null,-1)),n("p",null,v(a.$t("ai.source")),1),n("div",{innerHTML:i(o).render(i(oe)(e.srcFile))},null,8,we)],512),[[f,e.srcFile&&e.srcFile.length>0]]),h(n("div",be,[n("span",{class:g(["feedback-icon-good",{good:1===e.feedback}]),onClick:a=>le(1,e)},"üëç",10,xe),t[7]||(t[7]=d(" ¬† ",-1)),n("span",{class:g(["feedback-icon-bad",{bad:2===e.feedback}]),onClick:a=>le(2,e)},"üëé",10,Ae)],512),[[f,e?.content&&!Q.value]])])],64)):"user"===e.role?(s(),l(r,{key:1},[n("div",{class:"message-content",innerHTML:i(o).render(e.content)},null,8,ke),n("div",Ce,[c(i(W),{size:50},{default:u((()=>[...t[8]||(t[8]=[n("img",{src:"data:image/png;base64,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"},null,-1)])])),_:1})])],64)):x("",!0)],2)))),128))])):x("",!0),q.value?x("",!0):(s(),l("div",{key:1,class:"scroll-to-bottom-button",onClick:Y},[c(i(J),null,{default:u((()=>[c(i(P))])),_:1})]))])),_:1},512),n("div",Te,[c(i(B),{modelValue:O.value,"onUpdate:modelValue":t[1]||(t[1]=e=>O.value=e),class:"chat-input",placeholder:i(N)("ai.input.placeholder"),type:"textarea",autosize:{minRows:5,maxRows:10},maxlength:4e3,"show-word-limit":"",onKeydown:$,onInput:ee,onKeyup:ae},null,8,["modelValue","placeholder"]),c(i(_),{type:"primary",class:"chat-button",icon:i(E),circle:"",disabled:!O.value?.length,onClick:t[2]||(t[2]=e=>X())},null,8,["icon","disabled"])])])):x("",!0)],2))}}),[["__scopeId","data-v-36b17cd9"]]);var Ee=U(e({__name:"AIAssistantPage",setup(e){const t=X(),n=a(null),o=a(!0),i=a(!1),r=()=>{n.value.showChatManage=!n.value.showChatManage,n.value.showChatManage&&p((()=>{n.value.chatManageRef?.getHistoryListData()}))},v=()=>{(window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth)<768||t.query?.isMobile?(i.value=!0,o.value=!1,document.body.style.minWidth="0px"):(i.value=!1,o.value=!0,document.body.style.minWidth="768px")},m=()=>{if(i.value){const e=document.querySelector(".web-app");e&&(e.style.height=window.innerHeight+"px")}else{const e=document.querySelector(".web-app");e&&(e.style.height="")}};return w((()=>{v(),m(),i.value?m():p((()=>{n.value.getHistoryListData()})),window.addEventListener("resize",Y((()=>{v(),m()}),10)),window.addEventListener("orientationchange",(()=>{setTimeout((()=>{m()}),100)}))})),b((()=>{window.removeEventListener("resize",v),window.removeEventListener("orientationchange",m)})),(e,a)=>{const t=A("draggable");return s(),l("div",{class:g(["ai-assistant-page",{"full-page":o.value,"mobile-page":i.value}])},[c(Z,null,{"external-menu":u((()=>[h((s(),l("span",{class:g(["menu-button",{active:e.chatManageActive}]),onClick:r},[...a[0]||(a[0]=[d(" ‚å• ",-1)])],2)),[[f,i.value],[t,{device:"mobile"}]])])),_:1}),c(Pe,{ref_key:"chatViewRef",ref:n,class:"chat-view","is-fullscreen":o.value,"is-mobile":i.value},null,8,["is-fullscreen","is-mobile"])],2)}}}),[["__scopeId","data-v-6d8fbf27"]]);export{Ee as default};
