import{d as e,r as a,w as t,o as s,c as l,a as n,I as o,u as i,G as c,L as r,J as u,a2 as v,O as d,R as h,S as p,ai as m,n as f,H as g,M as y,f as w,F as x,C as b,ah as k}from"./@vue-b6573999.js";import{f as A,e as C,p as j}from"./@element-plus-142e0c99.js";import{M as P}from"./markdown-it-b5917cbb.js";import{S as T}from"./sse.js-f7ab3f8c.js";import{h as E,t as H}from"../index-2699b897.js";import{_ as I}from"./plugin-vue_export-helper-3b0dab4c.js";import{d as L,f as M,b as S,i as F,j as q,k as U,l as N,m as B,n as O,o as _}from"./element-plus-594afa91.js";import{u as z}from"./vue-router-e68aa853.js";import{j as R}from"./lodash-es-0d8c957d.js";import"./mdurl-265342ab.js";import"./uc.micro-caa990fc.js";import"./entities-a9d5f18d.js";import"./linkify-it-fb3f2949.js";import"./punycode.js-94cdf097.js";import"./axios-ff411c8f.js";import"./mitt-106818fe.js";import"./@vueuse-f9ccc613.js";import"./@popperjs-19b81b33.js";import"./async-validator-b6f94fc9.js";import"./@ctrl-d2fe7c9e.js";const Q={class:"chat-manage-container"},G={class:"chat-manage-card"},J={class:"chat-manage-header"},W={class:"chat-list"},V={class:"list-title fx"},X={class:"text"},Z={class:"list-content"},Y=["onClick"],D={class:"cont fx"};var K=I(e({__name:"chatManage",props:{newChat:{type:Function,required:!0,default:()=>{}},historyChat:{type:Function,required:!0,default:()=>{}},currContextId:{type:String,default:""},messageContext:{type:Array,default:()=>[]}},emits:["showChatManage"],setup(e,{expose:w,emit:x}){const b=e,k=a(),C=a(!1),j=a(""),P=a([]),T=a([]),I=a(b.currContextId),B=x;t((()=>b.currContextId),(e=>{I.value=e}));const O=()=>{B("showChatManage",!1),b.messageContext?.length?(I.value="",b.newChat(),_()):S({message:H("ai.already.latest.chat"),type:"success"})},_=()=>{var e,a;E.get("/v1/rest/jrag/context/list",{params:{offset:e,limit:a}}).then((e=>{P.value=e.data.data,R(j.value,e.data.data)}))},z=e=>{const a=[];e?a.push(e):P.value.forEach((e=>{a.push(e.contextId)})),F.confirm(H("ai.delete.warning"),H(e?"ai.delete.chat.confirm":"ai.delete.all.chat.confirm"),{confirmButtonText:H("common.ok"),cancelButtonText:H("common.cancel"),type:"warning"}).then((()=>{(e=>E.delete("/v1/rest/jrag/context",{params:{"context-id":Array.isArray(e)?e.join(","):e}}))(a).then((a=>{_(),e===I.value&&O()}))}))};t((()=>j.value),(e=>{R(e)}));const R=(e,a)=>{const t=new RegExp(e,"i"),s=a||P.value;T.value=s.filter((e=>t.test(e.title)))};return w({getHistoryListData:_}),(e,a)=>(s(),l("div",Q,[n("div",G,[n("div",J,[C.value?(s(),o(i(L),{key:0,ref_key:"searchInputRef",ref:k,modelValue:j.value,"onUpdate:modelValue":a[0]||(a[0]=e=>j.value=e),class:"search-input",placeholder:e.$t("ai.search.history.context"),"suffix-icon":i(A),autofocus:"",onBlur:a[1]||(a[1]=e=>C.value=!1)},null,8,["modelValue","placeholder","suffix-icon"])):(s(),l(c,{key:1},[r(i(M),{type:"primary",class:"add",round:"",onClick:O},{default:u((()=>[a[4]||(a[4]=n("i",{class:"iconfont icon-chat-new"},null,-1)),v(d(e.$t("ai.add.new.chat")),1)])),_:1,__:[4]}),r(i(M),{icon:i(A),circle:"",onClick:a[2]||(a[2]=e=>(C.value=!0,void f((()=>{j.value="",k.value.focus()}))))},null,8,["icon"])],64))]),h(n("div",W,[n("div",V,[n("div",X,d(e.$t("ai.history.chat")),1),n("div",{class:"delete",onClick:a[3]||(a[3]=e=>z())},[a[5]||(a[5]=n("i",{class:"iconfont icon-trash-alt"},null,-1)),v(d(e.$t("ai.delete.all.chat")),1)])]),n("div",Z,[(s(!0),l(c,null,m(T.value,((e,t)=>(s(),l("div",{key:t,class:g(["list-item fx",{active:I.value===e.contextId}]),onClick:a=>{return t=e.contextId,B("showChatManage",!1),I.value=t,b.historyChat(t),void(j.value="");var t}},[n("div",D,[a[6]||(a[6]=n("i",{class:"iconfont icon-lishiduihua"},null,-1)),n("p",null,d(e.title),1)]),r(i(N),{trigger:"hover",teleported:!1},{dropdown:u((()=>[r(i(q),null,{default:u((()=>[r(i(U),{onClick:y((a=>z(e.contextId)),["stop"])},{default:u((()=>[a[7]||(a[7]=n("i",{class:"iconfont icon-trash-alt"},null,-1)),v(" "+d(i(H)("common.delete")),1)])),_:2,__:[7]},1032,["onClick"])])),_:2},1024)])),default:u((()=>[a[8]||(a[8]=n("span",{class:"el-dropdown-link"},[n("span",{class:"iconfont icon-vgengduo"},"...")],-1))])),_:2,__:[8]},1024)],10,Y)))),128))])],512),[[p,T.value?.length]])])]))}}),[["__scopeId","data-v-3307a45e"]]);const $=e=>e&&0!==e.length?e.map((e=>`- [${e.fullFileName}](${e.url})`)).join("\n"):"";const ee={key:0,class:"chat-view"},ae={class:"message-init"},te={class:"title"},se={key:0,class:"message-list"},le={class:"message-content"},ne=["innerHTML"],oe={class:"src-file"},ie=["innerHTML"],ce={class:"support"},re=["onClick"],ue=["onClick"],ve=["innerHTML"],de={class:"avatar-wrap"},he={class:"input-area"};var pe=I(e({__name:"ChatView",props:{isFullscreen:{type:Boolean,default:!1},isMobile:{type:Boolean,default:!1}},setup(e,{expose:t}){const o=new P({html:!0,linkify:!0,typographer:!0});o.renderer.rules.paragraph_open=function(e,a){return'<p style="line-height: var(--n-font-line-height-4);">'},o.renderer.rules.link_open=function(e,a,t,s,l){return e[a].attrPush(["target","_blank"]),l.renderToken(e,a,t)};const y=a(!1),b=a(null),k=a(),A=a(),I=a(!0),q=a([]),U=a(""),N=a(!1),z=a(!0);let R;const Q=e=>{if(N.value)S.info(H("ai.assistant.waiting"));else if(e&&(U.value=e),U.value.trim()){N.value=!0,J();const e={index:q.value.length,content:U.value,role:"user"};q.value.push(e),U.value="";const a={contextId:k.value,messages:q.value};R=(e=>new T("/v1/rest/jrag/chat",{headers:{"Content-Type":"application/json"},method:"POST",payload:JSON.stringify(e)}))(a),R.onopen=()=>{z.value&&(q.value.push({index:q.value.length,role:"assistant",content:""}),z.value=!1),J()},R.onmessage=e=>{try{const a=JSON.parse(e.data);G(a)}catch(a){}},R.onerror=e=>{401===e.responseCode?window.location.assign("/#/login"):0!==e.responseCode&&(S.error(H("ai.assistant.service.unavailable")),N.value=!1,z.value=!0)}}},G=e=>{W(),I.value&&J(),"system"===e.message?.role?(q.value[q.value.length-1]=e.message,q.value.push({index:q.value.length,role:"assistant",content:""})):"assistant"===e.message?.role&&(q.value[q.value.length-1].index,e.message.index,!0===e.done?(q.value[q.value.length-1].content+=e.message.content,N.value=!1,z.value=!0,f((()=>{R.close()}))):(e.message.srcFile&&(q.value[q.value.length-1].srcFile=e.message.srcFile),e.message.content&&(q.value[q.value.length-1].content+=e.message.content)))},J=()=>{f((()=>{A.value&&A.value.wrapRef.scrollTo({top:A.value.wrapRef.scrollHeight,behavior:"smooth"})}))},W=()=>{if(A.value){const{scrollTop:e,scrollHeight:a,clientHeight:t}=A.value.wrapRef;I.value=e+100>a-t}};let V=!0;const X=e=>{"Enter"!==e.key||e.shiftKey||(V=!0,e.preventDefault())},Z=()=>{V=!1},Y=()=>{V&&(V=!1,Q())},D=(e,a)=>{var t;a.feedback=e,(t={contextId:k.value,index:a.index,feedback:e},E.post("/v1/rest/jrag/context/message/feedback",t)).then((a=>{1===e&&S({message:"😊",type:"info"}),2===e&&S({message:"😭",type:"info"})}))},pe=()=>{fe(),U.value="",q.value=[],I.value=!0,E.get("/v1/rest/jrag/context/id").then((e=>{k.value=e.data.contextId})),J()},me=e=>{fe(),U.value="",e!==k.value&&b.value.getHistoryListData(),k.value=e,(e=>E.get("/v1/rest/jrag/context",{params:{"context-id":e}}))(e).then((e=>{q.value=e.data.messages,J()}))},fe=()=>{N.value=!1,z.value=!0,R&&R.close()};return w((()=>{E.get("/v1/rest/jrag/ap-center/api/check").then((e=>{2===e.status?F.alert(H("ai.api.key.invalid"),{type:"error",message:H("ai.api.key.invalid.desc"),callback:()=>{}}):pe()}))})),t({showChatManage:y,chatManageRef:b,getHistoryListData:()=>b.value.getHistoryListData(),newChat:pe}),(a,t)=>(s(),l("div",{class:g(["chat-container",{fullscreen:e.isFullscreen,"is-mobile":e.isMobile}])},[h(r(K,{class:"chat-manage",ref_key:"chatManageRef",ref:b,"new-chat":pe,"history-chat":me,"curr-context-id":k.value,"message-context":q.value,onShowChatManage:t[0]||(t[0]=e=>y.value=e)},null,8,["curr-context-id","message-context"]),[[p,y.value||e.isFullscreen]]),!y.value||e.isFullscreen||e.isMobile&&!y.value?(s(),l("div",ee,[r(i(O),{ref_key:"scrollbarRef",ref:A,class:"scroll",onScroll:W},{default:u((()=>[n("div",ae,[t[3]||(t[3]=n("div",{class:"ai-logo"},[n("span",{style:{"font-size":"100px"}},"🤖")],-1)),n("h2",te,d(a.$t("ai.hi.assistant")),1)]),q.value?.length?(s(),l("div",se,[(s(!0),l(c,null,m(q.value,((e,m)=>(s(),l("div",{key:m,class:g(["message-row",[e.role]])},["assistant"===e.role?(s(),l(c,{key:0},[n("div",{class:g(["avatar-wrap",[N.value&&m===q.value.length-1?"thinking-avatar":""]])},[r(i(_),{size:50,class:"ai-chat-logo"},{default:u((()=>t[4]||(t[4]=[n("span",{style:{"font-size":"30px",margin:"auto"}},"🤖",-1)]))),_:1,__:[4]})],2),n("div",le,[n("div",{innerHTML:i(o).render(e.content+(N.value&&m===q.value.length-1?"...":""))},null,8,ne),h(n("div",oe,[t[5]||(t[5]=n("br",null,null,-1)),n("p",null,d(a.$t("ai.source")),1),n("div",{innerHTML:i(o).render(i($)(e.srcFile))},null,8,ie)],512),[[p,e.srcFile&&e.srcFile.length>0]]),h(n("div",ce,[n("span",{class:g(["feedback-icon-good",{good:1===e.feedback}]),onClick:a=>D(1,e)},"👍",10,re),t[6]||(t[6]=v("   ",-1)),n("span",{class:g(["feedback-icon-bad",{bad:2===e.feedback}]),onClick:a=>D(2,e)},"👎",10,ue)],512),[[p,e?.content&&!N.value]])])],64)):"user"===e.role?(s(),l(c,{key:1},[n("div",{class:"message-content",innerHTML:i(o).render(e.content)},null,8,ve),n("div",de,[r(i(_),{size:50},{default:u((()=>t[7]||(t[7]=[n("img",{src:"data:image/png;base64,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"},null,-1)]))),_:1,__:[7]})])],64)):x("",!0)],2)))),128))])):x("",!0),I.value?x("",!0):(s(),l("div",{key:1,class:"scroll-to-bottom-button",onClick:J},[r(i(B),null,{default:u((()=>[r(i(C))])),_:1})]))])),_:1},512),n("div",he,[r(i(L),{modelValue:U.value,"onUpdate:modelValue":t[1]||(t[1]=e=>U.value=e),class:"chat-input",placeholder:i(H)("ai.input.placeholder"),type:"textarea",autosize:{minRows:5,maxRows:10},maxlength:4e3,"show-word-limit":"",onKeydown:X,onInput:Z,onKeyup:Y},null,8,["modelValue","placeholder"]),r(i(M),{type:"primary",class:"chat-button",icon:i(j),circle:"",disabled:!U.value?.length,onClick:t[2]||(t[2]=e=>Q())},null,8,["icon","disabled"])])])):x("",!0)],2))}}),[["__scopeId","data-v-4d936bc8"]]);const me={class:"top-bar"};var fe=I(e({__name:"AIAssistantPage",setup(e){const t=z(),o=a(null),i=a(!0),c=a(!1),u=()=>{o.value.showChatManage=!o.value.showChatManage,o.value.showChatManage&&f((()=>{o.value.chatManageRef?.getHistoryListData()}))},d=()=>{(window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth)<768||t.query?.isMobile?(c.value=!0,i.value=!1,document.body.style.minWidth="0px"):(c.value=!1,i.value=!0,document.body.style.minWidth="768px")},m=()=>{if(c.value){const e=document.querySelector(".web-app");e&&(e.style.height=window.innerHeight+"px")}else{const e=document.querySelector(".web-app");e&&(e.style.height="")}};return w((()=>{d(),m(),c.value?m():f((()=>{o.value.getHistoryListData()})),window.addEventListener("resize",R((()=>{d(),m()}),10)),window.addEventListener("orientationchange",(()=>{setTimeout((()=>{m()}),100)}))})),b((()=>{window.removeEventListener("resize",d),window.removeEventListener("orientationchange",m)})),(e,a)=>{const t=k("draggable");return s(),l("div",{class:g(["ai-assistant-page",{"full-page":i.value,"mobile-page":c.value}])},[n("div",me,[a[1]||(a[1]=n("h3",null,"🤖 Jrag AI",-1)),h((s(),l("span",{class:g(["chat-menu",{active:o.value?.showChatManage}]),onClick:u},a[0]||(a[0]=[v(" ⌥ ",-1)]),2)),[[p,c.value],[t,{device:"mobile"}]])]),r(pe,{ref_key:"chatViewRef",ref:o,class:"chat-view","is-fullscreen":i.value,"is-mobile":c.value},null,8,["is-fullscreen","is-mobile"])],2)}}}),[["__scopeId","data-v-eaee0c76"]]);export{fe as default};
