import{d as e,r as a,w as l,Y as s,f as t,a3 as o,aa as i,U as r,o as u,c as d,a as n,R as c,L as v,Q as p,X as h,M as m,u as f,a4 as g,al as b}from"./@vue-bb747027.js";import{d as w}from"./vue-router-6370cc0f.js";import{l as x}from"./login.api-e9ba1edf.js";import{a as z}from"./axios-ff411c8f.js";import{t as y}from"../index-7487ad29.js";import{g as k,p as j}from"./oem-517c1d66.js";import{a as _,c as L,d as S,f as U,g as $,h as V}from"./element-plus-89dd23ed.js";import{_ as X}from"./plugin-vue_export-helper-3b0dab4c.js";import"./mitt-106818fe.js";import"./lodash-es-7a4ab7c3.js";import"./@popperjs-66964824.js";import"./@vueuse-09ca9f25.js";import"./@element-plus-ccefd8d4.js";import"./async-validator-b6f94fc9.js";import"./@ctrl-d2fe7c9e.js";import"./normalize-wheel-es-233dc293.js";const C={class:"slider-container"},R={class:"slider-square"},E={class:"box"},Y=e({__name:"SlipCaptcha",props:{loading:{type:Boolean,default:!1}},emits:["validPass"],setup(e,{expose:h,emit:m}){const f=a(!1),g=e;l((()=>g.loading),(e=>{f.value=e}));const b=m;h({updateSlideCaptcha:$});const w=a(null),x=a(null),L=a({hash:"",puzzleUrl:"",width:300,height:225,sliderUrl:"",sliderSize:0,sliderY:0,sliderLeft:0,blockX:0,blockY:0,scaleRatio:1,sliderText:""}),S=s({originX:0}),U=s({class:"",height:0});function $(){f.value=!0,x.value.style.transform="translate3d(0, 0, 0)",L.value.sliderLeft=0,z.get(`/v1${k}auth/${j}/captcha/slide?`+(new Date).getTime()).then((e=>{L.value.hash=e.data.hash,L.value.puzzleUrl=e.data.puzzleUrl,L.value.width=e.data.width,L.value.height=e.data.height,L.value.sliderUrl=e.data.sliderUrl,L.value.sliderSize=e.data.sliderSize,L.value.blockY=e.data.sliderY})).then((()=>{L.value.sliderText=y("captcha.tip"),U.height=0,U.class="",L.value.sliderLeft=0,x.value&&(x.value.style.left="0"),w.value&&(L.value.scaleRatio=300/L.value.width,L.value.width=L.value.width*L.value.scaleRatio,L.value.height=L.value.height*L.value.scaleRatio,L.value.blockY=L.value.blockY*L.value.scaleRatio,L.value.sliderSize=L.value.sliderSize*L.value.scaleRatio)})).finally((()=>{f.value=!1}))}t((()=>{q(),$()}));const V=a(!1),X=e=>{V.value=!0,L.value.sliderText="",S.originX=e.pageX||e.touches?.[0]?.pageX,x.value.style.willChange="transform",e.preventDefault()},Y=e=>{if(!V.value)return;const a=e.pageX||e.touches?.[0]?.pageX;if(!a)return;const l=a-S.originX,s=L.value.width-L.value.sliderSize,t=Math.max(0,Math.min(l,s));x.value.style.transform=`translate3d(${t}px, 0, 0)`,L.value.sliderLeft=t,e.preventDefault()},T=()=>{if(!V.value)return;V.value=!1,x.value.style.willChange="auto";const e=L.value.sliderLeft/L.value.scaleRatio;var a,l;(a=e,l=L.value.hash,z.get(`/v1${k}auth/${j}/captcha/slide/validate`,{params:{"slider-x":a,hash:l}})).then((e=>{e.data.result?b("validPass",{hash:L.value.hash,code:e.data.code}):(_.error(y("captcha.validate.fail")),$())}))},q=()=>{document.addEventListener("mousemove",Y),document.addEventListener("mouseup",T),document.addEventListener("touchmove",Y,{passive:!1}),document.addEventListener("touchend",T)};return o((()=>{document.removeEventListener("mousemove",Y),document.removeEventListener("mouseup",T),document.removeEventListener("touchmove",Y),document.removeEventListener("touchend",T)})),(e,a)=>{const l=i("loading");return r((u(),d("div",C,[n("div",{class:"slider-canvas",style:c({width:`${L.value.width}px`,height:`${L.value.height}px`}),onClick:$},[n("div",{ref_key:"puzzle",ref:w,class:"puzzle-image",style:c({backgroundImage:`url(${L.value.puzzleUrl})`,width:"100%",height:"100%",position:"absolute",top:0,left:0,backgroundSize:"cover"})},null,4),n("div",{ref_key:"block",ref:x,class:"slider-block",style:c({backgroundImage:`url(${L.value.sliderUrl})`,width:L.value.sliderSize+"px",height:L.value.sliderSize+"px",top:L.value.blockY+"px",left:"0px",position:"absolute",backgroundSize:"cover"})},null,4),n("div",{class:v(`result-mask ${U.class}`),style:c({height:`${U.height}px`})},null,6)],4),n("div",R,[n("div",E,[n("div",{class:"slider-square-icon",style:c({transform:`translateX(${L.value.sliderLeft}px)`}),onMousedown:X,onTouchstart:X},null,36),n("span",null,p(L.value.sliderText),1)])])])),[[l,f.value]])}}});const T={class:"login-container"},q={class:"logo-container"},M={class:"logo-text"};var D=X(e({__name:"Login",setup(e){const l=w(),t=a(),o=a(!1),i=a(!1),r=s({username:"",password:""}),c={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]},v=()=>{i.value=!0,t.value.updateSlideCaptcha()},z=e=>{o.value=!0,x(r.username,r.password,e.code,e.hash).then((()=>{l.push("/")})).catch((e=>{401===e.status&&(i.value=!1,_.error(y("login.fail")))}))};return(e,a)=>(u(),d("div",T,[h(f($),{ref:"loginForm",model:r,rules:c,"label-position":"left","label-width":"0px",class:"login-form",onKeyup:b(v,["enter"])},{default:m((()=>[n("div",q,[n("h2",M,p(f(y)("ai.center.title")),1)]),h(f(L),{prop:"username"},{default:m((()=>[h(f(S),{modelValue:r.username,"onUpdate:modelValue":a[0]||(a[0]=e=>r.username=e),placeholder:"用户名"},null,8,["modelValue"])])),_:1}),h(f(L),{prop:"password"},{default:m((()=>[h(f(S),{modelValue:r.password,"onUpdate:modelValue":a[1]||(a[1]=e=>r.password=e),type:"password",placeholder:"密码"},null,8,["modelValue"])])),_:1}),h(f(L),null,{default:m((()=>[h(f(U),{type:"primary",onClick:v,class:"submit-btn"},{default:m((()=>[...a[4]||(a[4]=[g(" 登录 ",-1)])])),_:1})])),_:1})])),_:1},8,["model"]),h(f(V),{modelValue:i.value,"onUpdate:modelValue":a[2]||(a[2]=e=>i.value=e),class:"captcha-dialog","align-center":"",loading:o.value,"show-close":"",onClose:a[3]||(a[3]=e=>o.value=!1),draggable:""},{default:m((()=>[h(Y,{ref_key:"slideCaptchaRef",ref:t,loading:o.value,onValidPass:z},null,8,["loading"])])),_:1},8,["modelValue","loading"])]))}}),[["__scopeId","data-v-1f66a56c"]]);export{D as default};
