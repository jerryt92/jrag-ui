import{d as e,r as a,w as l,U as s,f as t,a1 as o,ae as u,Q as i,o as r,c as d,a as n,O as c,H as v,M as p,S as h,J as m,u as g,a2 as f,ag as b,G as w}from"./@vue-215071e0.js";import{d as x}from"./vue-router-aac73014.js";import{t as z,l as y,a as k}from"../index-69ec14be.js";import{a as _}from"./axios-ff411c8f.js";import{b as j,c as L,d as S,f as U,g as V,h as C}from"./element-plus-195aa41e.js";import{_ as X}from"./plugin-vue_export-helper-3b0dab4c.js";import"./mitt-106818fe.js";import"./lodash-es-ca13b026.js";import"./@vueuse-3587b3f7.js";import"./@element-plus-c56474c5.js";import"./async-validator-b6f94fc9.js";import"./@popperjs-19b81b33.js";import"./normalize-wheel-es-233dc293.js";import"./@ctrl-d2fe7c9e.js";const E={class:"slider-container"},R={class:"slider-square"},$={class:"box"},Y=e({__name:"SlipCaptcha",props:{loading:{type:Boolean,default:!1}},emits:["validPass"],setup(e,{expose:h,emit:m}){const g=a(!1),f=e;l((()=>f.loading),(e=>{g.value=e}));const b=m;h({updateSlideCaptcha:S});const w=a(null),x=a(null),y=a({hash:"",puzzleUrl:"",width:300,height:225,sliderUrl:"",sliderSize:0,sliderY:0,sliderLeft:0,blockX:0,blockY:0,scaleRatio:1,sliderText:""}),k=s({originX:0}),L=s({class:"",height:0});function S(){g.value=!0,x.value.style.transform="translate3d(0, 0, 0)",y.value.sliderLeft=0,_.get("/v1/auth/captcha/slide?"+(new Date).getTime()).then((e=>{y.value.hash=e.data.hash,y.value.puzzleUrl=e.data.puzzleUrl,y.value.width=e.data.width,y.value.height=e.data.height,y.value.sliderUrl=e.data.sliderUrl,y.value.sliderSize=e.data.sliderSize,y.value.blockY=e.data.sliderY})).then((()=>{y.value.sliderText=z("captcha.tip"),L.height=0,L.class="",y.value.sliderLeft=0,x.value&&(x.value.style.left="0"),w.value&&(y.value.scaleRatio=300/y.value.width,y.value.width=y.value.width*y.value.scaleRatio,y.value.height=y.value.height*y.value.scaleRatio,y.value.blockY=y.value.blockY*y.value.scaleRatio,y.value.sliderSize=y.value.sliderSize*y.value.scaleRatio)})).finally((()=>{g.value=!1}))}t((()=>{Y(),S()}));const U=a(!1),V=e=>{U.value=!0,y.value.sliderText="",k.originX=e.pageX||e.touches?.[0]?.pageX,x.value.style.willChange="transform",e.preventDefault()},C=e=>{if(!U.value)return;const a=e.pageX||e.touches?.[0]?.pageX;if(!a)return;const l=a-k.originX,s=y.value.width-y.value.sliderSize,t=Math.max(0,Math.min(l,s));x.value.style.transform=`translate3d(${t}px, 0, 0)`,y.value.sliderLeft=t,e.preventDefault()},X=()=>{if(!U.value)return;U.value=!1,x.value.style.willChange="auto";const e=y.value.sliderLeft/y.value.scaleRatio;var a,l;(a=e,l=y.value.hash,_.get("/v1/auth/captcha/slide/validate",{params:{"slider-x":a,hash:l}})).then((e=>{e.data.result?b("validPass",{hash:y.value.hash,code:e.data.code}):(j.error(z("captcha.validate.fail")),S())}))},Y=()=>{document.addEventListener("mousemove",C),document.addEventListener("mouseup",X),document.addEventListener("touchmove",C,{passive:!1}),document.addEventListener("touchend",X)};return o((()=>{document.removeEventListener("mousemove",C),document.removeEventListener("mouseup",X),document.removeEventListener("touchmove",C),document.removeEventListener("touchend",X)})),(e,a)=>{const l=u("loading");return i((r(),d("div",E,[n("div",{class:"slider-canvas",style:c({width:`${y.value.width}px`,height:`${y.value.height}px`}),onClick:S},[n("div",{ref_key:"puzzle",ref:w,class:"puzzle-image",style:c({backgroundImage:`url(${y.value.puzzleUrl})`,width:"100%",height:"100%",position:"absolute",top:0,left:0,backgroundSize:"cover"})},null,4),n("div",{ref_key:"block",ref:x,class:"slider-block",style:c({backgroundImage:`url(${y.value.sliderUrl})`,width:y.value.sliderSize+"px",height:y.value.sliderSize+"px",top:y.value.blockY+"px",left:"0px",position:"absolute",backgroundSize:"cover"})},null,4),n("div",{class:v(`result-mask ${L.class}`),style:c({height:`${L.height}px`})},null,6)],4),n("div",R,[n("div",$,[n("div",{class:"slider-square-icon",style:c({transform:`translateX(${y.value.sliderLeft}px)`}),onMousedown:V,onTouchstart:V},null,36),n("span",null,p(y.value.sliderText),1)])])])),[[l,g.value]])}}});const T={class:"login-container"};var q=X(e({__name:"Login",setup(e){const l=x(),o=a(),u=a(!1),i=a(!1);t((()=>{"public"===y&&l.push("/")}));const c=s({username:"",password:""}),v={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]},p=()=>{i.value=!0,o.value.updateSlideCaptcha()},_=e=>{u.value=!0,k(c.username,c.password,e.code,e.hash).then((()=>{l.push("/")})).catch((e=>{401===e.status&&(i.value=!1,j.error(z("login.fail")))}))};return(e,a)=>(r(),d(w,null,[n("div",T,[h(g(V),{ref:"loginForm",model:c,rules:v,"label-position":"left","label-width":"0px",class:"login-form",onKeyup:b(p,["enter"])},{default:m((()=>[a[5]||(a[5]=n("div",{class:"logo-container"},[n("h2",{class:"logo-text"},"Jrag")],-1)),h(g(L),{prop:"username"},{default:m((()=>[h(g(S),{modelValue:c.username,"onUpdate:modelValue":a[0]||(a[0]=e=>c.username=e),placeholder:"用户名"},null,8,["modelValue"])])),_:1}),h(g(L),{prop:"password"},{default:m((()=>[h(g(S),{modelValue:c.password,"onUpdate:modelValue":a[1]||(a[1]=e=>c.password=e),type:"password",placeholder:"密码"},null,8,["modelValue"])])),_:1}),h(g(L),null,{default:m((()=>[h(g(U),{type:"primary",onClick:p,class:"submit-btn"},{default:m((()=>[...a[4]||(a[4]=[f(" 登录 ",-1)])])),_:1})])),_:1})])),_:1},8,["model"])]),h(g(C),{modelValue:i.value,"onUpdate:modelValue":a[2]||(a[2]=e=>i.value=e),class:"captcha-dialog","align-center":"",loading:u.value,"show-close":"",onClose:a[3]||(a[3]=e=>u.value=!1)},{default:m((()=>[h(Y,{ref_key:"slideCaptchaRef",ref:o,loading:u.value,onValidPass:_},null,8,["loading"])])),_:1},8,["modelValue","loading"])],64))}}),[["__scopeId","data-v-495eac40"]]);export{q as default};
